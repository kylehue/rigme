"use strict";function _typeof(i){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(i){return typeof i}:function(i){return i&&"function"==typeof Symbol&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i})(i)}function _toConsumableArray(i){return _arrayWithoutHoles(i)||_iterableToArray(i)||_unsupportedIterableToArray(i)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(i,e){if(i){if("string"==typeof i)return _arrayLikeToArray(i,e);var t=Object.prototype.toString.call(i).slice(8,-1);return"Map"===(t="Object"===t&&i.constructor?i.constructor.name:t)||"Set"===t?Array.from(i):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(i,e):void 0}}function _iterableToArray(i){if("undefined"!=typeof Symbol&&null!=i[Symbol.iterator]||null!=i["@@iterator"])return Array.from(i)}function _arrayWithoutHoles(i){if(Array.isArray(i))return _arrayLikeToArray(i)}function _arrayLikeToArray(i,e){(null==e||e>i.length)&&(e=i.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=i[t];return n}function _classCallCheck(i,e){if(!(i instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(i,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}function _createClass(i,e,t){return e&&_defineProperties(i.prototype,e),t&&_defineProperties(i,t),i}var timeline,events=require("../../../lib/events.js"),mouse=require("../../../lib/mouse.js"),vector=require("../../../lib/vector.js"),config=require("../../../lib/config.js"),utils=require("../../../lib/utils.js"),history=require("./history.js"),RigModel=function(){function i(){_classCallCheck(this,i),this.joints=[],this.keyframes={},this.totalKeyframes=0,this.mouseBuffer=10,this.activeJoint=null,this.bounds={min:vector(),max:vector()},this._moved=!1}return _createClass(i,[{key:"updateBounds",value:function(){for(var i=Object.keys(this.keyframes),e=[],t=[],n=0;n<i.length;n++)for(var s=this.keyframes[i[n]],o=0;o<s.joints.length;o++){var r=s.joints[o];if(e.push(r.position.x+config.render.joint.radius),t.push(r.position.y+config.render.joint.radius),e.push(r.position.x-config.render.joint.radius),t.push(r.position.y-config.render.joint.radius),r.skin.vertices)for(var a=0;a<r.skin.vertices.length;a++)e.push(r.skin.vertices[a].x),t.push(r.skin.vertices[a].y)}this.bounds.min.set({x:Math.min.apply(Math,e),y:Math.min.apply(Math,t)}),this.bounds.max.set({x:Math.max.apply(Math,e),y:Math.max.apply(Math,t)})}},{key:"reset",value:function(){this.keyframes={},this.joints=[],this.totalKeyframes=0,this.activeJoint=null,timeline.graph&&(this.setKeyframe(0,{position:{x:timeline.graph.hatchMark.spacing/2,y:0},locked:!0,ignoreHistory:!0}),timeline.graph.setCurrentMark(0),timeline.graph.updateState()),this.updateBounds(),history.add({label:"Clear",value:this.clone(),group:"keyframe"})}},{key:"clone",value:function(i){return i=i||this.keyframes,this.fromJSON(this.toJSON(i))}},{key:"getKeyframe",value:function(e,t){var i=Object.values(this.keyframes).find(function(i){return i[e]===t});return i?this.keyframes[i.index]:null}},{key:"editJoints",value:function(i){for(var e=Object.values(this.keyframes),t=0;t<e.length;t++)for(var n=e[t],s=0;s<n.joints.length;s++){var o=n.joints[s];"function"==typeof i&&i(o,n)}}},{key:"editJoint",value:function(e,i,t){for(var n=Object.values(this.keyframes),s=0;s<n.length;s++){var o=n[s].joints.find(function(i){return i.id===e});if(i=t?JSON.parse(JSON.stringify(i)):i,o)for(var r=Object.keys(i),a=0;a<r.length;a++)o[r[a]]=i[r[a]]}}},{key:"addSubKeyframes",value:function(i,e){if(timeline.graph){for(var t=Object.keys(this.keyframes),n=0;n<t.length;n++)if("sub"==this.keyframes[t[n]].type){t.splice(n,1);break}this.clone();if(1<t.length){timeline.graph.updateState();for(n=e-1;i+1<=n;n--){var s=this.clone(),o=s[e].joints,o={id:utils.uid(),type:"sub",index:n,activeJointId:s.activeJointId,joints:o,render:{size:12,color:"red",position:vector(n*timeline.graph.hatchMark.spacing+timeline.graph.hatchMark.spacing/2,0)}};this.keyframes[n]=o}}}this.updateSubKeyframes(),timeline.graph.updateState(),timeline.graph.redraw()}},{key:"updateSubKeyframes",value:function(){for(var i=Object.keys(this.keyframes),e=i.length-1;0<=e;e--){var r=this.keyframes[i[e]];if(r&&"head"!=r.type){for(var t=null,a=r.index;0<=a;a--){var n=this.keyframes[a];if(n&&"head"==n.type){t=n.index;break}}for(var s=null,a=r.index;a<timeline.app.totalFrames;a++){var o=this.keyframes[a];if(o&&"head"==o.type){s=o.index;break}}for(var h,l=utils.map(r.index,s,t,0,1),f=this.keyframes[s],c=this.keyframes[t],a=0;a<r.joints.length;a++)!function(){var e=r.joints[a];if(e){var i=f.joints.find(function(i){return i.id===e.id}),t=c.joints.find(function(i){return i.id===e.id});if(i&&t){var n=i.position.copy().lerp(t.position,l),s=utils.lerp(i.length,t.length,l);for(e.length=s,e.position.set(n),config.animateSkin&&t.skin&&i.skin&&t.skin.offset&&i.skin.offset&&(e.skin.offset={x:utils.lerp(i.skin.offset.x,t.skin.offset.x,l),y:utils.lerp(i.skin.offset.y,t.skin.offset.y,l),scaleX:utils.lerp(i.skin.offset.scaleX,t.skin.offset.scaleX,l),scaleY:utils.lerp(i.skin.offset.scaleY,t.skin.offset.scaleY,l),angle:utils.lerp(i.skin.offset.angle,t.skin.offset.angle,l)}),h=0;h<e.children.length;h++){var o=e.children[h];o.angle=o.position.heading(e.position)}}e.id==c.activeJointId&&(r.activeJointId=e.id)}}();"linear"!=config.riggingMode&&("forwardKinematics"==config.riggingMode?this.computeKinematics(r.joints):"inverseKinematics"==config.riggingMode&&this.computeKinematics(r.joints,!0)),this.updateSkin(r.joints)}}}},{key:"setKeyframe",value:function(i,e){if("number"==typeof i){var t,n={type:"head",index:(e=e||{}).keyframe?e.keyframe.index:i,activeJointId:e.keyframe?e.keyframe.activeJointId:this.activeJoint?this.activeJoint.id:null,joints:e.joints,render:{size:config.render.keyframe.size,color:config.render.keyframe.color.default,position:e.position||vector(i*timeline.graph.hatchMark.spacing+timeline.graph.hatchMark.spacing/2,0)},locked:e.locked||!1};if(timeline.graph&&(t=(t=this.clone()[timeline.graph.state.currentFrame])?t.joints:[],e.joints&&(t=e.joints),n.joints=t),n.id=e.id||utils.uid(),this.keyframes[i]=n,timeline.graph&&(timeline.graph.updateState(),t=timeline.graph.state.currentFrame,i=timeline.graph.state.previousFrame,this.addSubKeyframes(i,t),timeline.graph.redraw()),!e.ignoreHistory){for(var s=Object.values(this.keyframes),o=0,r=0;r<s.length;r++)"head"==s[r].type&&o++;e="Add keyframe";return o==this.totalKeyframes&&(e="Move keyframe"),this.updateBounds(),history.add({label:e,value:this.clone(),group:"keyframe"}),this.totalKeyframes=o,n}}}},{key:"deleteKeyframe",value:function(i){i=this.getKeyframe("id",i);if(i&&!(Object.keys(this.keyframes).length<=1)){for(var e,t,n=[],s=i.index-1;0<=s;s--){var o=this.keyframes[s];if(o&&("sub"==o.type&&n.push(o),"head"==o.type)){e=o;break}}for(s=i.index+1;s<timeline.app.totalFrames;s++){var r=this.keyframes[s];if(r&&("sub"==r.type&&n.push(r),"head"==r.type)){t=r;break}}for(s=0;s<n.length;s++){var a=this.getKeyframe("id",n[s].id);delete this.keyframes[a.index]}delete this.keyframes[i.index],t&&e&&this.addSubKeyframes(e.index,t.index),timeline.graph&&(timeline.graph.updateState(),timeline.graph.redraw()),this.updateBounds()}}},{key:"updateKeyframe",value:function(i,e){for(var t=Object.keys(e),n=0;n<t.length;n++)this.keyframes[i][t[n]]=e[t[n]];this.updateSubKeyframes()}},{key:"addJoint",value:function(i,e,t){t=t||{},timeline.graph&&timeline.graph.setCurrentMark(timeline.graph.state.currentFrame,!1);var n=t.parent||this.activeJoint,e={id:"J"+utils.uid(),name:"Joint ".concat(this.joints.length+1),position:vector(i,e),positionPrev:vector(i,e),angle:n?vector(i,e).heading(n.position):0,parent:n||null,children:[],length:n?n.position.dist(i,e):0,hierarchy:n?n.hierarchy+1:1,skin:{},zIndex:this.joints.length+1};return n&&n.children.push(e),t.ignoreDefaults||(this.activeJoint=e),this.joints.push(e),timeline.graph&&this.updateKeyframe(timeline.graph.state.currentFrame,{activeJointId:this.activeJoint.id}),this.updateBounds(),t.ignoreHistory||history.add({label:"Add joint",value:this.clone(),group:"keyframe"}),events.emit("jointChange",this.joints),e}},{key:"selectJoint",value:function(t,n){var e;this.joints.length&&((e=this.joints.slice()).sort(function(i,e){return i.position.dist(t,n)-e.position.dist(t,n)}),this.activeJoint=this.joints.find(function(i){return i.id===e[0].id}),events.emit("jointChange",this.joints),timeline.graph&&this.updateKeyframe(timeline.graph.state.currentFrame,{activeJointId:this.activeJoint.id}))}},{key:"removeJointById",value:function(e){for(var i=Object.keys(this.keyframes),t=0;t<i.length;t++){var n=this.keyframes[i[t]],s=n.joints.find(function(i){return i.id===e});if(s){for(var o,r=0;r<s.children.length;r++){var a=s.children[r];a.parent=s.parent,a.length+=s.length,this.activeJoint=a}s.parent?(s.parent.children.splice(s.parent.children.indexOf(s),1),(o=s.parent.children).push.apply(o,_toConsumableArray(s.children)),this.activeJoint=s.parent):this.activeJoint=s.children[0],n.joints.splice(n.joints.indexOf(s),1)}}this.activeJoint&&this.moveJoint(this.activeJoint.position.x,this.activeJoint.position.y),this.updateBounds(),history.add({label:"Remove joint",value:this.clone(),group:"keyframe"}),events.emit("jointChange",this.joints)}},{key:"removeJointByPosition",value:function(i,e){if(this.joints.length)for(var t=0;t<this.joints.length;t++){var n=this.joints[t];n.position.dist(i,e)<config.render.joint.radius+this.mouseBuffer&&this.removeJointById(n.id)}}},{key:"computeKinematics",value:function(i,e){if(e)for(n=i.length-1;0<=n;n--){var t=i[n];t.parent&&(t.parent.angle=t.position.heading(t.parent.position),t.parent.position.set({x:t.position.x+Math.cos(t.parent.angle)*t.length,y:t.position.y+Math.sin(t.parent.angle)*t.length}))}else for(var n=0;n<i.length;n++)for(var s=i[n],o=0;o<s.children.length;o++){var r=s.children[o];r.angle=r.position.heading(s.position),r.position.set({x:s.position.x-Math.cos(r.angle)*r.length,y:s.position.y-Math.sin(r.angle)*r.length})}}},{key:"updateSkin",value:function(i){i=i||this.joints;for(var e=0;e<i.length;e++){var t=i[e],n=t.length,s=t.length,o=0,r=t.skin.crop,a=0,h=0;r&&(a=r.to.x-r.from.x,h=r.to.y-r.from.y),h<a?s=Number.MAX_SAFE_INTEGER:(n=Number.MAX_SAFE_INTEGER,o=Math.PI/2),t.skin.size=utils.scaleSize(a,h,n,s),t.skin._sizeOriginal={width:a,height:h},t.skin.angleAuto=o;var h=0,o=0,l=1,f=1,c=0;if(t.skin.offset&&(h=t.skin.offset.x||0,o=t.skin.offset.y||0,l=t.skin.offset.scaleX||0,f=t.skin.offset.scaleY||0,c=t.skin.offset.angle||0),t.parent&&r){t.skin.position={x:(t.position.x+t.parent.position.x)/2,y:(t.position.y+t.parent.position.y)/2};for(var o=[{x:t.skin.position.x+h-t.skin.size.width/2,y:t.skin.position.y+o-t.skin.size.height/2},{x:t.skin.position.x+h+t.skin.size.width/2,y:t.skin.position.y+o-t.skin.size.height/2},{x:t.skin.position.x+h+t.skin.size.width/2,y:t.skin.position.y+o+t.skin.size.height/2},{x:t.skin.position.x+h-t.skin.size.width/2,y:t.skin.position.y+o+t.skin.size.height/2}],p=0,d=o;p<d.length;p++){var u=d[p],y=u.x-t.skin.position.x,g=u.y-t.skin.position.y;u.x=u.x+y*(l-1),u.y=u.y+g*(f-1)}for(var m=0,k=o;m<k.length;m++){var v=k[m],j=t.angle+t.skin.angleAuto+c,x=(v.x-t.skin.position.x)*Math.cos(j)-(v.y-t.skin.position.y)*Math.sin(j),j=(v.x-t.skin.position.x)*Math.sin(j)+(v.y-t.skin.position.y)*Math.cos(j);v.x=x+t.skin.position.x,v.y=j+t.skin.position.y}t.skin.vertices=o}}}},{key:"moveJoint",value:function(i,e){if(this.activeJoint){var t,n;if(timeline.graph&&(config.animation.autoAddKeyframe?this.activeJoint.position.equals(i,e)||(t=timeline.graph.state.currentMark,(n=this.keyframes[t])&&"head"==n.type||this.setKeyframe(t)):(timeline.graph.setCurrentMark(timeline.graph.state.currentFrame,!1),timeline.graph.updateState()),this.updateSubKeyframes()),i&&e&&(1<this.activeJoint.position.dist(this.activeJoint.positionPrev)&&(this._moved=!0,this.activeJoint.positionPrev.set(this.activeJoint.position.x,this.activeJoint.position.y)),this.activeJoint.position.set(i,e),"linear"==config.riggingMode)){this.activeJoint.parent&&(this.activeJoint.angle=this.activeJoint.position.heading(this.activeJoint.parent.position),this.activeJoint.length=this.activeJoint.position.dist(this.activeJoint.parent.position));for(var s=0;s<this.activeJoint.children.length;s++){var o=this.activeJoint.children[s];o.length=o.position.dist(this.activeJoint.position)}}"linear"!=config.riggingMode&&("forwardKinematics"==config.riggingMode?this.computeKinematics(this.joints):"inverseKinematics"==config.riggingMode&&this.computeKinematics(this.joints,!0)),this.updateSkin(),this.updateBounds()}}},{key:"getJoint",value:function(e){return this.joints.find(function(i){return i.id===e})||null}},{key:"toJSON",value:function(i,e){for(var t=i||this.clone(),n={},s=Object.keys(t),o=0;o<s.length;o++){for(var r=t[s[o]],a={id:r.id,activeJointId:r.activeJointId,index:r.index,joints:[],render:r.render,type:r.type,locked:r.locked},h=0;h<r.joints.length;h++){for(var l=r.joints[h],f={id:l.id,name:l.name,angle:l.angle,position:l.position,positionPrev:l.positionPrev,length:l.length,parent:l.parent?l.parent.id:null,hierarchy:l.hierarchy,children:[],skinImageSrc:l.skin&&!e?l.skin.imageSrc:void 0,skinCrop:l.skin?l.skin.crop:null,skinOffset:l.skin?l.skin.offset:null,skinPosition:l.skin?l.skin.position:null,skinAngleAuto:l.skin?l.skin.angleAuto:void 0,skinSize:l.skin?l.skin.size:null,_skinSizeOriginal:l.skin?l.skin._sizeOriginal:null,_vueCrop:l.skin?l.skin._vueCrop:null,zIndex:l.zIndex},c=0;c<l.children.length;c++){var p=l.children[c];f.children.push(p.id)}a.joints.push(f)}n[a.index]=a}return n}},{key:"fromJSON",value:function(o){if(o){for(var r,a,h={},l=Object.keys(o),i=function(){var i=l[f],e=o[i],n=(e.joints.find(function(i){return i.id===e.activeJointId}),[]);for(r=0;r<e.joints.length;r++){var t=e.joints[r],t={id:t.id,name:t.name,angle:t.angle,position:vector(t.position),positionPrev:vector(t.positionPrev),length:t.length,hierarchy:t.hierarchy,parent:t.parent,children:t.children.slice(),skin:{offset:t.skinOffset,crop:t.skinCrop,_vueCrop:t._vueCrop,imageSrc:t.skinImageSrc,position:t.skinPosition,angleAuto:t.angleAuto,size:t.skinSize,_sizeOriginal:t._skinSizeOriginal},zIndex:t.zIndex};n.push(t)}function s(){var t=n[r];for(t.parent=n.find(function(i){return i.id===t.parent})||null,a=0;a<t.children.length;a++)!function(){var e=t.children[a];t.children[a]=n.find(function(i){return i.id===e})||null}()}for(r=0;r<n.length;r++)s();i={activeJointId:e.activeJointId,id:e.id,index:e.index,joints:n,locked:e.locked,render:e.render,type:e.type};h[e.index]=i},f=0;f<l.length;f++)i();return h}}},{key:"import",value:function(i){this.keyframes=this.clone(i);for(var e=Object.values(this.keyframes),t=0,n=0;n<e.length;n++)"head"==e[n].type&&t++;this.totalKeyframes=t,timeline.graph&&((i=this.keyframes[timeline.graph.state.currentMark])&&(this.activeJoint=this.getKeyframe("id",i.activeJointId),this.activeJoint&&this.updateKeyframe(timeline.graph.state.currentFrame,{activeJointId:this.activeJoint.id})),timeline.graph.updateState()),this.updateSkin(),this.updateBounds(),events.emit("jointChange",this.joints)}},{key:"renderTo",value:function(i,e){var t=this.keyframes[(e=e||{}).frame];if(t){e.position=e.position||{x:0,y:0};var n=-this.bounds.min.x+e.position.x,s=-this.bounds.min.y+e.position.y;if(t.joints.sort(function(i,e){return i.zIndex-e.zIndex}),e.showSkin)for(var o=0;o<t.joints.length;o++){var r,a,h,l,f,c=t.joints[o];c.parent&&(c.skin.imageSrc&&(c.skin.image?c.skin.image.width||((l=new Image).src=c.skin.imageSrc,c.skin.image=l,this.updateSkin(),this.updateBounds()):((f=new Image).src=c.skin.imageSrc,c.skin.image=f,this.updateSkin(),this.updateBounds())),c.skin&&"object"==_typeof(c.skin.image)&&c.skin.image.src&&c.skin.position&&(i.save(),i.translate(c.skin.position.x+n,c.skin.position.y+s),i.rotate(c.angle+c.skin.angleAuto),c.skin.offset&&(r=c.skin.offset.x,a=c.skin.offset.y,h=c.skin.offset.scaleX,l=c.skin.offset.scaleY,f=c.skin.offset.angle,i.rotate(f),i.translate(r,a),i.scale(h,l)),i.drawImage(c.skin.image,c.skin.crop.from.x,c.skin.crop.from.y,c.skin._sizeOriginal.width,c.skin._sizeOriginal.height,-c.skin.size.width/2,-c.skin.size.height/2,c.skin.size.width,c.skin.size.height),i.restore(),c.skin.vertices||(this.updateSkin(),this.updateBounds())))}if(e.showBones){for(o=0;o<t.joints.length;o++){var p=t.joints[o];p.parent&&(i.beginPath(),i.moveTo(p.position.x+n,p.position.y+s),i.lineTo(p.parent.position.x+n,p.parent.position.y+s),i.lineWidth=config.render.segment.width,i.lineCap="round",i.strokeStyle=config.render.segment.color,i.stroke())}for(o=0;o<t.joints.length;o++){var d=t.joints[o],u=d===this.activeJoint?config.render.joint.color.selected:config.render.joint.color.default;timeline.graph&&(this.activeJoint&&!timeline.graph.state.isPlaying&&(this.activeJoint.children.length&&(u=this.activeJoint.children.includes(d)?"#5bff85":u),this.activeJoint.parent&&(u=this.activeJoint.parent===d?"#9b68e1":u)),timeline.graph.state.isPlaying&&(u=config.render.joint.color.default)),i.beginPath(),i.arc(d.position.x+n,d.position.y+s,config.render.joint.radius,0,2*Math.PI),i.closePath(),i.fillStyle=e.workColor?u:config.render.joint.color.default,i.fill()}}}}},{key:"render",value:function(i){var e,t,n,s;timeline.graph&&(e=timeline.graph.state.previousFrame,t=timeline.graph.state.currentFrame,n=timeline.graph.state.nextFrame,s=timeline.graph.state.currentMark,i.save(),i.context.globalAlpha=.1,this.renderTo(i.context,{frame:e,position:{x:this.bounds.min.x,y:this.bounds.min.y},showBones:!0}),this.renderTo(i.context,{frame:t,position:{x:this.bounds.min.x,y:this.bounds.min.y},showBones:!0}),this.renderTo(i.context,{frame:n,position:{x:this.bounds.min.x,y:this.bounds.min.y},showBones:!0}),i.restore(),this.keyframes[s]||(s=t),this.renderTo(i.context,{frame:s,position:{x:this.bounds.min.x,y:this.bounds.min.y},showBones:!0,showSkin:!0,workColor:!0}))}}]),i}(),rigModel=new RigModel;events.once("loadedApps",function(i){timeline=i.timeline,rigModel.setKeyframe(0,{locked:!0,ignoreHistory:!0})}),module.exports=rigModel;