"use strict";var pct,events=require("../../lib/events.js"),utils=require("../../lib/utils.js"),HAVE_ENOUGH_DATA=4;function extractFrames(e,n){var i,a,o,s,r,c,m,d,u,g;(n=n||{}).drop||(i=document.createElement("canvas"),a=i.getContext("2d"),(o=document.createElement("video")).crossOrigin="anonymous",o.controls=!0,o.muted=!0,o.src=e,o.load(),s=[],r=n.start||1,c=n.frameRate||24,m=n.quality||.1,d=n.width||640,u=n.height||480,o.addEventListener("loadedmetadata",function(){var e=n.end||o.duration,t=n.frameCount||(e-r)*c,e=utils.scaleSize(o.videoWidth,o.videoHeight,d,u);i.width=e.width,i.height=e.height,o.currentTime=r,o.addEventListener("seeked",function(){!n.drop&&s.length<t?(events.emit("extractKeyframeProgress",t),o.currentTime+=1/c):events.emit("extractKeyframeDone",s)})}),g=events.on("extractKeyframeProgress",function(e){a.drawImage(o,0,0,i.width,i.height);var t=i.toDataURL("image/jpeg",m),r=new Image;r.crossOrigin="anonymous",r.src=t;r={image:r,time:o.currentTime};s.push(r),a.clearRect(0,0,i.width,i.height),"function"==typeof n.progress&&(pct=s.length/e*100,n.progress(r.image,pct))}),events.once("extractKeyframeDone",function(e){e.sort(function(e,t){return e.time-t.time});for(var t=0;t<e.length;t++)e[t]=e[t].image;n.done(e),events.removeListener(g),i.remove()}))}module.exports=extractFrames;