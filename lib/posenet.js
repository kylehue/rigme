"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t,e){"object"==("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?e(exports,require("@tensorflow/tfjs-core"),require("@tensorflow/tfjs-converter")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-core","@tensorflow/tfjs-converter"],e):e(t.posenet={},t.tf,t.tf)}(void 0,function(t,y,s){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function e(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var v=function(){return(v=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function b(i,u,s,a){return new(s=s||Promise)(function(t,e){function r(t){try{o(a.next(t))}catch(t){e(t)}}function n(t){try{o(a.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(r,n)}o((a=a.apply(i,u||[])).next())})}function w(r,n){var o,i,u,s={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(u=2&e[0]?i.return:e[0]?i.throw||((u=i.return)&&u.call(i),0):i.next)&&!(u=u.call(i,e[1])).done)return u;switch(i=0,(e=u?[2&e[0],u.value]:e)[0]){case 0:case 1:u=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(u=0<(u=s.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){s.label=e[1];break}if(6===e[0]&&s.label<u[1]){s.label=u[1],u=e;break}if(u&&s.label<u[2]){s.label=u[2],s.ops.push(e);break}u[2]&&s.ops.pop(),s.trys.pop();continue}e=n.call(r,s)}catch(t){e=[6,t],i=0}finally{o=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var r,o=(u.prototype.predict=function(e){var r=this;return y.tidy(function(){var t=r.preprocessInput(y.cast(e,"float32")),t=y.expandDims(t,0),t=r.model.predict(t).map(function(t){return y.squeeze(t,[0])}),t=r.nameOutputResults(t);return{heatmapScores:y.sigmoid(t.heatmap),offsets:t.offsets,displacementFwd:t.displacementFwd,displacementBwd:t.displacementBwd}})},u.prototype.dispose=function(){this.model.dispose()},u),a=(e(i,r=o),i.prototype.preprocessInput=function(t){return y.tidy(function(){return y.sub(y.div(t,127.5),1)})},i.prototype.nameOutputResults=function(t){return{offsets:t[0],heatmap:t[1],displacementFwd:t[2],displacementBwd:t[3]}},i);function i(){return null!==r&&r.apply(this,arguments)||this}function u(t,e){this.model=t,this.outputStride=e;var r=this.model.inputs[0].shape;y.util.assert(-1===r[1]&&-1===r[2],function(){return"Input shape ["+r[1]+", "+r[2]+"] must both be equal to or -1"})}function l(t){return Math.floor(t/2)}var h=(f.prototype.enqueue=function(t){this.priorityQueue[++this.numberOfElements]=t,this.swim(this.numberOfElements)},f.prototype.dequeue=function(){var t=this.priorityQueue[0];return this.exchange(0,this.numberOfElements--),this.sink(0),this.priorityQueue[this.numberOfElements+1]=null,t},f.prototype.empty=function(){return-1===this.numberOfElements},f.prototype.size=function(){return this.numberOfElements+1},f.prototype.all=function(){return this.priorityQueue.slice(0,this.numberOfElements+1)},f.prototype.max=function(){return this.priorityQueue[0]},f.prototype.swim=function(t){for(;0<t&&this.less(l(t),t);)this.exchange(t,l(t)),t=l(t)},f.prototype.sink=function(t){for(;2*t<=this.numberOfElements;){var e=2*t;if(e<this.numberOfElements&&this.less(e,e+1)&&e++,!this.less(t,e))break;this.exchange(t,e),t=e}},f.prototype.getValueAt=function(t){return this.getElementValue(this.priorityQueue[t])},f.prototype.less=function(t,e){return this.getValueAt(t)<this.getValueAt(e)},f.prototype.exchange=function(t,e){var r=this.priorityQueue[t];this.priorityQueue[t]=this.priorityQueue[e],this.priorityQueue[e]=r},f);function f(t,e){this.priorityQueue=new Array(t),this.numberOfElements=-1,this.getElementValue=e}var g=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"],p=g.length,c=g.reduce(function(t,e,r){return t[e]=r,t},{}),d=[["nose","leftEye"],["leftEye","leftEar"],["nose","rightEye"],["rightEye","rightEar"],["nose","leftShoulder"],["leftShoulder","leftElbow"],["leftElbow","leftWrist"],["leftShoulder","leftHip"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["nose","rightShoulder"],["rightShoulder","rightElbow"],["rightElbow","rightWrist"],["rightShoulder","rightHip"],["rightHip","rightKnee"],["rightKnee","rightAnkle"]],m=[["leftHip","leftShoulder"],["leftElbow","leftShoulder"],["leftElbow","leftWrist"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["rightHip","rightShoulder"],["rightElbow","rightShoulder"],["rightElbow","rightWrist"],["rightHip","rightKnee"],["rightKnee","rightAnkle"],["leftShoulder","rightShoulder"],["leftHip","rightHip"]].map(function(t){var e=t[0],t=t[1];return[c[e],c[t]]});function _(t,e,r,n){return{y:n.get(t,e,r),x:n.get(t,e,r+p)}}function x(t,e,r){var n=_(t.heatmapY,t.heatmapX,t.id,r),r=n.y,n=n.x;return{x:t.heatmapX*e+n,y:t.heatmapY*e+r}}function S(t,e,r){return t<e?e:r<t?r:t}function E(t,e){return{x:t.x+e.x,y:t.y+e.y}}var M=d.map(function(t){var e=t[0],t=t[1];return[c[e],c[t]]}),k=M.map(function(t){return t[1]}),O=M.map(function(t){return t[0]});function I(t,e,r,n){return{y:S(Math.round(t.y/e),0,r-1),x:S(Math.round(t.x/e),0,n-1)}}function j(t,e,r,n,o,i,u,s){void 0===s&&(s=2);for(var a=n.shape,l=a[0],f=a[1],p=(p=t,a=I(e.position,i,l,f),u=(t=u).shape[2]/2,{y:t.get(a.y,a.x,p),x:t.get(a.y,a.x,u+p)}),c=E(e.position,p),h=0;h<s;h++)var d=I(c,i,l,f),m=_(d.y,d.x,r,o),c=E({x:d.x*i,y:d.y*i},{x:m.x,y:m.y});var p=I(c,i,l,f),p=n.get(p.y,p.x,r);return{position:c,part:g[r],score:p}}function R(t,r,e,n){var o=e.x,i=e.y;return t.some(function(t){var e=t.keypoints[n].position;return(t=e.y-i)*t+(e=e.x-o)*e<=r})}function N(t,e,r,n,o,i,u,s){void 0===s&&(s=20);for(var a=[],l=function(t,e){for(var r=e.shape,n=r[0],o=r[1],i=r[2],u=new h(n*o*i,function(t){return t.score}),s=0;s<n;++s)for(var a=0;a<o;++a)for(var l=0;l<i;++l){var f=e.get(s,a,l);f<t||function(t,e,r,n,o,i){for(var u=(l=i.shape)[0],s=l[1],a=!0,l=Math.max(r-o,0),f=Math.min(r+o+1,u),p=l;p<f;++p){for(var c=Math.max(n-o,0),h=Math.min(n+o+1,s),d=c;d<h;++d)if(i.get(p,d,t)>e){a=!1;break}if(!a)break}return a}(l,f,s,a,1,e)&&u.enqueue({score:f,part:{heatmapY:s,heatmapX:a,id:l}})}return u}(u=void 0===u?.5:u,t),f=s*s;a.length<i&&!l.empty();){var p,c=l.dequeue();R(a,f,x(c.part,o,e),c.part.id)||(c=function(o,i,t){return t.reduce(function(t,e,r){var n=e.position,e=e.score;return R(o,i,n,r)||(t+=e),t},0)/t.length}(a,f,p=function(t,e,r,n,o,i){var u=e.shape[2],s=k.length,a=new Array(u),l=t.part,u=t.score,t=x(l,n,r);a[l.id]={score:u,part:g[l.id],position:t};for(var f=s-1;0<=f;--f){var p=k[f],c=O[f];a[p]&&!a[c]&&(a[c]=j(f,a[p],c,e,r,n,i))}for(f=0;f<s;++f)p=O[f],c=k[f],a[p]&&!a[c]&&(a[c]=j(f,a[p],c,e,r,n,o));return a}(c,t,e,o,r,n)),a.push({keypoints:p,score:c}))}return a}function P(e,r,n){return y.tidy(function(){var t=function(t,e){for(var r,n,o=[],i=0;i<p;i++){var u=(r=t.get(i,0).valueOf(),u=t.get(i,1).valueOf(),s=i,{y:(n=e).get(r,u,s),x:n.get(r,u,s+p)}),s=u.x;o.push(u.y),o.push(s)}return y.tensor2d(o,[p,2])}(e,n);return y.add(y.cast(y.mul(e.toTensor(),y.scalar(r,"int32")),"float32"),t)})}function B(h,d,m){return b(this,void 0,void 0,function(){var r,n,a,l,f,p,c;return w(this,function(t){switch(t.label){case 0:return r=0,e=(o=h).shape,i=e[0],u=e[1],s=e[2],n=y.tidy(function(){var e,r,t=y.reshape(o,[i*u,s]),n=y.argMax(t,0),t=y.expandDims(y.div(n,y.scalar(u,"int32")),1),n=y.expandDims((e=n,r=u,y.tidy(function(){var t=y.div(e,y.scalar(r,"int32"));return y.sub(e,y.mul(t,y.scalar(r,"int32")))})),1);return y.concat([t,n],1)}),[4,Promise.all([h.buffer(),d.buffer(),n.buffer()])];case 1:return f=t.sent(),a=f[0],c=f[1],l=f[2],[4,(f=P(l,m,c)).buffer()];case 2:return p=t.sent(),c=Array.from(function(t,e){for(var r=e.shape[0],n=new Float32Array(r),o=0;o<r;o++){var i=e.get(o,0),u=e.get(o,1);n[o]=t.get(i,u,o)}return n}(a,l)),c=c.map(function(t,e){return r+=t,{position:{y:p.get(e,0),x:p.get(e,1)},part:g[e],score:t}}),n.dispose(),f.dispose(),[2,{keypoints:c,score:r/c.length}]}var o,e,i,u,s})})}var q,A="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/mobilenet/",H="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/resnet50/",T=[-123.15,-115.9,-103.06],V=(e(Y,q=o),Y.prototype.preprocessInput=function(t){return y.add(t,T)},Y.prototype.nameOutputResults=function(t){var e=t[0],r=t[1];return{offsets:t[2],heatmap:t[3],displacementFwd:e,displacementBwd:r}},Y);function Y(){return null!==q&&q.apply(this,arguments)||this}var F=Number.NEGATIVE_INFINITY,K=Number.POSITIVE_INFINITY;function Q(t){return t.reduce(function(t,e){var r=t.maxX,n=t.maxY,o=t.minX,i=t.minY,t=e.position,e=t.x,t=t.y;return{maxX:Math.max(r,e),maxY:Math.max(n,t),minX:Math.min(o,e),minY:Math.min(i,t)}},{maxX:F,maxY:F,minX:K,minY:K})}function X(t,n,o,i,u){return void 0===i&&(i=0),void 0===u&&(u=0),{score:t.score,keypoints:t.keypoints.map(function(t){var e=t.score,r=t.part,t=t.position;return{score:e,part:r,position:{x:t.x*o+u,y:t.y*n+i}}})}}function z(t,e){return G(t,e)?t:Math.floor(t/e)*e+1}function D(t){y.util.assert("number"==typeof t||"object"==_typeof(t),function(){return"Invalid inputResolution "+t+". Should be a number or an object with width and height"}),"object"==_typeof(t)&&(y.util.assert("number"==typeof t.width,function(){return"inputResolution.width has a value of "+t.width+" which is invalid; it must be a number"}),y.util.assert("number"==typeof t.height,function(){return"inputResolution.height has a value of "+t.height+" which is invalid; it must be a number"}))}function W(t,e){return D(t),"object"==_typeof(t)?[z(t.height,e),z(t.width,e)]:[z(t,e),z(t,e)]}var C=[8,16,32];function G(t,e){return(t-1)%e==0}function U(t){return t instanceof y.Tensor?[t.shape[0],t.shape[1]]:[t.height,t.width]}function J(e,t){var r=t[0],n=t[1],o=U(e),i=o[0],u=o[1],t=n/r,o=[0,0,0,0],s=o[0],a=o[1],l=o[2],f=o[3],f=u/i<t?(a=s=0,l=Math.round(.5*(t*i-u)),Math.round(.5*(t*i-u))):(s=Math.round(.5*(1/t*u-i)),a=Math.round(.5*(1/t*u-i)),l=0);return{resized:y.tidy(function(){var t=e instanceof y.Tensor?e:y.browser.fromPixels(e),t=y.pad3d(t,[[s,a],[l,f],[0,0]]);return y.image.resizeBilinear(t,[r,n])}),padding:{top:s,left:l,right:f,bottom:a}}}function L(t,e,r,n,o){var i,u,s,a,l,f=e[0],p=e[1],e=r[0],r=r[1],t=(t=t,i=(f+n.top+n.bottom)/e,u=(p+n.left+n.right)/r,s=-n.top,a=-n.left,void 0===s&&(s=0),void 0===a&&(a=0),1==u&&1==i&&0===s&&0===a?t:t.map(function(t){return X(t,i,u,s,a)}));return o?(l=p)<=0?t:t.map(function(t){return n=l,{score:t.score,keypoints:t.keypoints.map(function(t){var e=t.score,r=t.part,t=t.position;return{score:e,part:r,position:{x:n-1-t.x,y:t.y}}})};var n}):t}var Z={architecture:"MobileNetV1",outputStride:16,multiplier:.75,inputResolution:257},$=["MobileNetV1","ResNet50"],tt={MobileNetV1:[8,16,32],ResNet50:[32,16]},et={MobileNetV1:[.5,.75,1],ResNet50:[1]},rt=[1,2,4],nt={flipHorizontal:!1},ot={flipHorizontal:!1,maxDetections:5,scoreThreshold:.5,nmsRadius:20},it=(ut.prototype.estimateMultiplePoses=function(y,g){return void 0===g&&(g=ot),b(this,void 0,void 0,function(){var e,r,n,o,i,u,s,a,l,f,p,c,h,d,m;return w(this,function(t){switch(t.label){case 0:return e=v({},ot,g),function(t){var e=t.maxDetections,r=t.scoreThreshold,t=t.nmsRadius;if(e<=0)throw new Error("Invalid maxDetections "+e+". Should be > 0");if(r<0||1<r)throw new Error("Invalid scoreThreshold "+r+". Should be in range [0.0, 1.0]");if(t<=0)throw new Error("Invalid nmsRadius "+t+".")}(g),r=this.baseModel.outputStride,n=this.inputResolution,c=U(y),o=c[0],i=c[1],h=J(y,n),u=h.resized,s=h.padding,d=this.baseModel.predict(u),a=d.heatmapScores,l=d.offsets,f=d.displacementFwd,p=d.displacementBwd,[4,function(e){return b(this,void 0,void 0,function(){return w(this,function(t){return[2,Promise.all(e.map(function(t){return t.buffer()}))]})})}([a,l,f,p])];case 1:return m=t.sent(),c=m[0],h=m[1],d=m[2],m=m[3],[4,N(c,h,d,m,r,e.maxDetections,e.scoreThreshold,e.nmsRadius)];case 2:return m=t.sent(),m=L(m,[o,i],n,s,e.flipHorizontal),a.dispose(),l.dispose(),f.dispose(),p.dispose(),u.dispose(),[2,m]}})})},ut.prototype.estimateSinglePose=function(c,h){return void 0===h&&(h=nt),b(this,void 0,void 0,function(){var e,r,n,o,i,u,s,a,l,f,p;return w(this,function(t){switch(t.label){case 0:return e=v({},nt,h),p=this.baseModel.outputStride,r=this.inputResolution,a=U(c),n=a[0],o=a[1],l=J(c,r),i=l.resized,u=l.padding,f=this.baseModel.predict(i),s=f.heatmapScores,a=f.offsets,l=f.displacementFwd,f=f.displacementBwd,[4,B(s,a,p)];case 1:return p=t.sent(),p=L([p],[n,o],r,u,e.flipHorizontal),s.dispose(),a.dispose(),l.dispose(),f.dispose(),i.dispose(),[2,p[0]]}})})},ut.prototype.estimatePoses=function(e,r){return b(this,void 0,void 0,function(){return w(this,function(t){switch(t.label){case 0:return"single-person"!==r.decodingMethod?[3,2]:[4,this.estimateSinglePose(e,r)];case 1:return[2,[t.sent()]];case 2:return[2,this.estimateMultiplePoses(e,r)]}})})},ut.prototype.dispose=function(){this.baseModel.dispose()},ut);function ut(t,e){var r,n,o=t.outputStride;y.util.assert("number"==typeof o,function(){return"outputStride is not a number"}),y.util.assert(0<=C.indexOf(o),function(){return"outputStride of "+o+" is invalid. It must be either 8, 16, or 32"}),r=e,n=t.outputStride,y.util.assert("number"==typeof r[0]&&"number"==typeof r[1],function(){return"both resolution values must be a number but had values "+r}),y.util.assert(G(r[0],n),function(){return"height of "+r[0]+" is invalid for output stride "+n+"."}),y.util.assert(G(r[1],n),function(){return"width of "+r[1]+" is invalid for output stride "+n+"."}),this.baseModel=t,this.inputResolution=e}function st(u){return b(this,void 0,void 0,function(){var n,o,i;return w(this,function(t){switch(t.label){case 0:if(n=u.outputStride,o=u.quantBytes,i=u.multiplier,null==y)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this\n        model.");return e={1:"100",.75:"075",.5:"050"},r="model-stride"+n+".json",o=4===o?A+"float/"+e[i]+"/"+r:A+"quant"+o+"/"+e[i]+"/"+r,[4,s.loadGraphModel(u.modelUrl||o)];case 1:return i=t.sent(),o=new a(i,n),i=W(u.inputResolution,o.outputStride),[2,new it(o,i)]}var e,r})})}function at(i){return b(this,void 0,void 0,function(){var r,n,o;return w(this,function(t){switch(t.label){case 0:if(r=i.outputStride,o=i.quantBytes,null==y)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this\n        model.");return e="model-stride"+r+".json",n=4===o?H+"float/"+e:H+"quant"+o+"/"+e,[4,s.loadGraphModel(i.modelUrl||n)];case 1:return o=t.sent(),n=new V(o,r),o=W(i.inputResolution,n.outputStride),[2,new it(n,o)]}var e})})}t.decodeMultiplePoses=N,t.decodeSinglePose=B,t.MobileNet=a,t.partChannels=["left_face","right_face","right_upper_leg_front","right_lower_leg_back","right_upper_leg_back","left_lower_leg_front","left_upper_leg_front","left_upper_leg_back","left_lower_leg_back","right_feet","right_lower_leg_front","left_feet","torso_front","torso_back","right_upper_arm_front","right_upper_arm_back","right_lower_arm_back","left_lower_arm_front","left_upper_arm_front","left_upper_arm_back","left_lower_arm_back","right_hand","right_lower_arm_front","left_hand"],t.partIds=c,t.partNames=g,t.poseChain=d,t.load=function(e){return void 0===e&&(e=Z),b(this,void 0,void 0,function(){return w(this,function(t){return"ResNet50"===(e=function(t){if(null==(t=t||Z).architecture&&(t.architecture="MobileNetV1"),$.indexOf(t.architecture)<0)throw new Error("Invalid architecture "+t.architecture+". Should be one of "+$);if(null==t.inputResolution&&(t.inputResolution=257),D(t.inputResolution),null==t.outputStride&&(t.outputStride=16),tt[t.architecture].indexOf(t.outputStride)<0)throw new Error("Invalid outputStride "+t.outputStride+". Should be one of "+tt[t.architecture]+" for architecture "+t.architecture+".");if(null==t.multiplier&&(t.multiplier=1),et[t.architecture].indexOf(t.multiplier)<0)throw new Error("Invalid multiplier "+t.multiplier+". Should be one of "+et[t.architecture]+" for architecture "+t.architecture+".");if(null==t.quantBytes&&(t.quantBytes=4),rt.indexOf(t.quantBytes)<0)throw new Error("Invalid quantBytes "+t.quantBytes+". Should be one of "+rt+" for architecture "+t.architecture+".");if("MobileNetV1"===t.architecture&&32===t.outputStride&&1!==t.multiplier)throw new Error("When using an output stride of 32, you must select 1 as the multiplier.");return t}(e)).architecture?[2,at(e)]:"MobileNetV1"===e.architecture?[2,st(e)]:[2,null]})})},t.PoseNet=it,t.getAdjacentKeyPoints=function(i,u){return m.reduce(function(t,e){var r,n=e[0],o=e[1];return r=i[n].score,e=i[o].score,r<u||e<u||t.push([i[n],i[o]]),t},[])},t.getBoundingBox=Q,t.getBoundingBoxPoints=function(t){var e=Q(t),r=e.minX,n=e.minY,t=e.maxX,e=e.maxY;return[{x:r,y:n},{x:t,y:n},{x:t,y:e},{x:r,y:e}]},t.scaleAndFlipPoses=L,t.scalePose=X,t.version="2.2.2",Object.defineProperty(t,"__esModule",{value:!0})});